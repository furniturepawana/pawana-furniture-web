<section class="catalogue-hero">
  <div class="catalogue-hero-content">
    <h1><%= (typeof catalogueSettings !== 'undefined' && catalogueSettings.pageTitle) ? catalogueSettings.pageTitle : 'Our Collection' %></h1>
    <p><%= (typeof catalogueSettings !== 'undefined' && catalogueSettings.pageDescription) ? catalogueSettings.pageDescription : 'Explore our exquisite range of handcrafted furniture' %></p>
  </div>
</section>

<!-- Breadcrumb -->
<section class="breadcrumb-section">
  <div class="breadcrumb-container">
    <div class="page-breadcrumb">
      <a href="javascript:history.back()" class="breadcrumb-back" aria-label="Go back">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12h18M3 12l6-6M3 12l6 6"/>
        </svg>
      </a>
      <a href="/">Home</a> /
      <span>Catalogue</span>
    </div>
  </div>
</section>

<section class="catalogue-section">
  <div class="catalogue-container">
    <!-- Products Area with Top Filters -->
    <div class="catalogue-products">

      <!-- Header with Dropdown Filters -->
      <div class="catalogue-header">
        <div class="catalogue-header-left">
          <div class="title-block">
            <h2>
              <% if (filters.view === 'items') { %>
                Individual Items
              <% } else if (filters.view === 'sets') { %>
                Furniture Sets
              <% } else { %>
                All Products
              <% } %>
            </h2>
            <p class="results-count">
              Showing <%= (filters.view === 'all' || filters.view === 'items' ? items.length : 0) + (filters.view === 'all' || filters.view === 'sets' ? sets.length : 0) %> results
            </p>
          </div>
        </div>

        <!-- Room Tabs (Center) -->
        <div class="room-filter-tabs style-filter-tabs filter-tabs-compact" id="room-tabs">
          <%
            const roomDisplayNames = {
              'Living Room': 'Living',
              'Bedroom': 'Bedroom',
              'Dining Room': 'Dining',
              'Office': 'Office',
              'Showpieces': 'Showpieces'
            };
            const roomOrder = ['Living Room', 'Bedroom', 'Dining Room', 'Office', 'Showpieces'];
            const sortedRooms = [...allRooms].sort((a, b) => roomOrder.indexOf(a) - roomOrder.indexOf(b));
          %>
          <button class="style-tab active" data-room="" onclick="updateRoomFilter('')">All</button>
          <% sortedRooms.forEach(room => { %>
            <button class="style-tab" data-room="<%= room %>" onclick="updateRoomFilter('<%= room %>')">
              <%= roomDisplayNames[room] || room %>
            </button>
          <% }); %>
        </div>

        <!-- Dropdown Filters (Right) -->
        <div class="catalogue-filters-right" id="catalogue-filters-right">
          <!-- Dropdowns Wrapper (Always visible on mobile now) -->
          <div class="filter-dropdowns-wrapper">
            <!-- View Custom Dropdown -->
            <div class="filter-dropdown custom-dropdown" id="view-dropdown">
              <button class="custom-select-trigger" onclick="toggleCustomDropdown('view')">
                <span id="view-trigger-text">
                  <%= filters.view === 'items' ? 'Items' : (filters.view === 'sets' ? 'Sets' : 'All') %>
                </span>
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
              </button>
              <div class="custom-select-options" id="view-options">
                <div class="custom-option <%= filters.view === 'all' ? 'active' : '' %>" onclick="selectCustomOption('view', 'all', 'All')">All View</div>
                <div class="custom-option <%= filters.view === 'items' ? 'active' : '' %>" onclick="selectCustomOption('view', 'items', 'Items')">Items</div>
                <div class="custom-option <%= filters.view === 'sets' ? 'active' : '' %>" onclick="selectCustomOption('view', 'sets', 'Sets')">Sets</div>
              </div>
              <select id="view-filter" onchange="updateFilter('view', this.value)">
                <option value="all" <%= filters.view === 'all' ? 'selected' : '' %>>All</option>
                <option value="items" <%= filters.view === 'items' ? 'selected' : '' %>>Items</option>
                <option value="sets" <%= filters.view === 'sets' ? 'selected' : '' %>>Sets</option>
              </select>
            </div>

            <!-- Type Custom Dropdown -->
            <div class="filter-dropdown custom-dropdown" id="type-dropdown">
              <button class="custom-select-trigger" onclick="toggleCustomDropdown('type')">
                <span id="type-trigger-text"><%= filters.type || 'All Types' %></span>
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
              </button>
              <div class="custom-select-options" id="type-options">
                <div class="custom-option <%= !filters.type ? 'active' : '' %>" onclick="selectCustomOption('type', '', 'All Types')">All Types</div>
                <!-- Dynamic options injected by updateAdaptiveFilters -->
              </div>
              <select id="type-filter" onchange="updateFilter('type', this.value)">
                <option value="" <%= !filters.type ? 'selected' : '' %>>All Types</option>
                <% allTypes.forEach(type => { %>
                  <option value="<%= type %>" <%= filters.type && filters.type.toLowerCase() === type.toLowerCase() ? 'selected' : '' %>><%= type %></option>
                <% }); %>
              </select>
            </div>

            <!-- Style Custom Dropdown -->
            <div class="filter-dropdown custom-dropdown" id="style-dropdown">
              <button class="custom-select-trigger" onclick="toggleCustomDropdown('style')">
                <span id="style-trigger-text"><%= filters.style || 'All Styles' %></span>
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
              </button>
              <div class="custom-select-options" id="style-options">
                <div class="custom-option <%= !filters.style ? 'active' : '' %>" onclick="selectCustomOption('style', '', 'All Styles')">All Styles</div>
                <!-- Dynamic options injected by updateAdaptiveFilters -->
              </div>
              <select id="style-filter" onchange="updateFilter('style', this.value)">
                <option value="" <%= !filters.style ? 'selected' : '' %>>All Styles</option>
                <% allStyles.forEach(style => { %>
                  <option value="<%= style %>" <%= filters.style === style ? 'selected' : '' %>><%= style %></option>
                <% }); %>
              </select>
            </div>

            <!-- Clear Filters Button -->
            <button class="clear-filters-btn-top" onclick="clearFilters()" title="Clear all filters">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>

          <!-- Filter Toggle Button (mobile only) -->
          <button class="filter-toggle-btn" id="filterToggleBtn" aria-label="Toggle filters">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Sets Grid (First row) -->
      <div class="catalogue-sets-grid">
        <% sets.forEach(set => { %>
          <div class="set-card-wrapper catalogue-item"
             data-style="<%= set.style %>"
             data-room="<%= set.room %>"
             data-product-type="set">
            <a href="/set/<%= set.slug %>" class="set-card">
              <div class="set-card-badge">Set</div>
              <img
                src="<%= set.images && set.images.length > 0 ? set.images[0].url : '/images/placeholder.jpg' %>"
                alt="<%= set.name %>"
                loading="lazy"
              />
              <div class="card-name-row">
                <h3><%= set.name %></h3>
                <button class="wishlist-btn"
                        data-id="<%= set._id %>"
                        data-type="set"
                        data-name="<%= set.name %>"
                        data-slug="<%= set.slug %>"
                        data-image="<%= set.images && set.images.length > 0 ? set.images[0].url : '/images/placeholder.jpg' %>"
                        onclick="handleWishlistClick(event, this)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                  </svg>
                </button>
              </div>
              <div class="set-card-meta">
                <span class="set-style-badge <%= set.style.toLowerCase() %>"><%= set.style %></span>
                <p><span class="room-badge"><%= set.room %></span> · <%= set.code %></p>
              </div>
            </a>
          </div>
        <% }); %>
      </div>

      <!-- Items Grid -->
      <div class="catalogue-items-grid">
        <% items.forEach(item => { %>
          <div class="product-card-wrapper catalogue-item"
             data-style="<%= item.style %>"
             data-room="<%= item.room %>"
             data-type="<%= item.type %>"
             data-product-type="item">
            <a href="/item/<%= item.slug %>" class="product-card">
              <img
                src="<%= item.images && item.images.length > 0 ? item.images[0].url : '/images/placeholder.jpg' %>"
                alt="<%= item.name %>"
                loading="lazy"
              />
              <div class="card-name-row">
                <h3><%= item.name %></h3>
                <button class="wishlist-btn"
                        data-id="<%= item._id %>"
                        data-type="item"
                        data-name="<%= item.name %>"
                        data-slug="<%= item.slug %>"
                        data-image="<%= item.images && item.images.length > 0 ? item.images[0].url : '/images/placeholder.jpg' %>"
                        onclick="handleWishlistClick(event, this)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                  </svg>
                </button>
              </div>
              <div class="product-card-meta">
                <span class="item-style-badge <%= item.style.toLowerCase() %>"><%= item.style %></span>
                <p><span class="room-badge"><%= item.room %></span> · <%= item.type %> · <%= item.code %></p>
              </div>
            </a>
          </div>
        <% }); %>
      </div>

      <!-- Pagination (at bottom) -->
      <div class="pagination-container" id="catalogue-pagination"></div>

      <!-- No Results -->
      <div class="no-results" style="display: none;">
        <h3>No products found</h3>
        <p>Try adjusting your filters to see more results</p>
        <button class="btn-primary" onclick="clearFilters()">Clear Filters</button>
      </div>
    </div>

  </div>
</section>

<script>
let cataloguePagination = null;
let currentRoomFilter = '';
let allFilterData = {
  types: [],
  styles: []
};

// Capture all unique types and styles on load
document.addEventListener('DOMContentLoaded', function() {
  const cards = document.querySelectorAll('.catalogue-item');
  const typeSet = new Set();
  const styleSet = new Set();

  cards.forEach(card => {
    if (card.dataset.type) typeSet.add(card.dataset.type);
    if (card.dataset.style) styleSet.add(card.dataset.style);
  });

  allFilterData.types = Array.from(typeSet).sort();
  allFilterData.styles = Array.from(styleSet).sort();

  // Mobile Filter Toggle
  const filterToggleBtn = document.getElementById('filterToggleBtn');
  const filtersRight = document.getElementById('catalogue-filters-right');

  if (filterToggleBtn && filtersRight) {
    filterToggleBtn.addEventListener('click', function() {
      filtersRight.classList.toggle('filters-open');
      filterToggleBtn.classList.toggle('active');
    });
  }
});

function updateFilter(filterName, value) {
  // If type filter is changed to a specific type (not "All Types"), automatically select "Items"
  if (filterName === 'type' && value !== '') {
    const viewSelect = document.getElementById('view-filter');
    viewSelect.value = 'items';
  }
  applyFilters();
}

function updateRoomFilter(value) {
  currentRoomFilter = value;

  // Update active tab UI
  const tabs = document.querySelectorAll('#room-tabs .style-tab');
  tabs.forEach(tab => {
    if (tab.getAttribute('data-room') === value) {
      tab.classList.add('active');
    } else {
      tab.classList.remove('active');
    }
  });

  applyFilters();
}

// Custom Dropdown Logic
function toggleCustomDropdown(id) {
  const options = document.getElementById(id + '-options');
  const trigger = options.previousElementSibling;

  // Close other dropdowns
  document.querySelectorAll('.custom-select-options').forEach(opt => {
    if (opt.id !== id + '-options') {
      opt.classList.remove('visible');
      opt.previousElementSibling.classList.remove('active');
    }
  });

  options.classList.toggle('visible');
  trigger.classList.toggle('active');
}

function selectCustomOption(id, value, text) {
  const triggerText = document.getElementById(id + '-trigger-text');
  const select = document.getElementById(id + '-filter');

  triggerText.textContent = text;
  select.value = value;

  // Update active state in UI
  const options = document.getElementById(id + '-options');
  options.querySelectorAll('.custom-option').forEach(opt => {
    if (opt.textContent.trim() === text) opt.classList.add('active');
    else opt.classList.remove('active');
  });

  options.classList.remove('visible');
  options.previousElementSibling.classList.remove('active');

  // Logic: Switching to a type automatically switches to 'Items' view
  if (id === 'type' && value !== '') {
    const viewSelect = document.getElementById('view-filter');
    viewSelect.value = 'items';
    document.getElementById('view-trigger-text').textContent = 'Items';

    // Update View active state
    document.querySelectorAll('#view-options .custom-option').forEach(opt => {
      if (opt.textContent.trim() === 'Items') opt.classList.add('active');
      else opt.classList.remove('active');
    });
  }

  applyFilters();
}

// Close dropdowns on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.custom-dropdown')) {
    document.querySelectorAll('.custom-select-options').forEach(opt => opt.classList.remove('visible'));
    document.querySelectorAll('.custom-select-trigger').forEach(trig => trig.classList.remove('active'));
  }
});

function applyFilters() {
  const viewFilter = document.getElementById('view-filter').value;
  const roomFilter = currentRoomFilter;
  const typeFilter = document.getElementById('type-filter').value;
  const styleFilter = document.getElementById('style-filter').value;

  const allCards = document.querySelectorAll('.catalogue-item');
  const setsGrid = document.querySelector('.catalogue-sets-grid');
  const itemsGrid = document.querySelector('.catalogue-items-grid');
  const noResults = document.querySelector('.no-results');

  let visibleCount = 0;
  let visibleSets = 0;
  let visibleItems = 0;

  allCards.forEach(card => {
    const productType = card.dataset.productType;
    const style = card.dataset.style;
    const room = card.dataset.room;
    const type = card.dataset.type;

    let show = true;

    if (viewFilter === 'sets' && productType !== 'set') show = false;
    if (viewFilter === 'items' && productType !== 'item') show = false;
    if (styleFilter && style !== styleFilter) show = false;
    if (roomFilter && room !== roomFilter) show = false;

    if (typeFilter) {
      if (productType === 'set') {
        show = false;
      } else if (type && type.toLowerCase() !== typeFilter.toLowerCase()) {
        show = false;
      }
    }

    if (show) {
      card.removeAttribute('data-filtered-out');
      card.style.display = ''; // Restore display
      visibleCount++;
      if (productType === 'set') visibleSets++;
      else visibleItems++;
    } else {
      card.setAttribute('data-filtered-out', 'true');
      card.style.display = 'none';
    }
  });

  setsGrid.style.display = visibleSets > 0 ? 'grid' : 'none';
  itemsGrid.style.display = visibleItems > 0 ? 'grid' : 'none';

  const headerTitle = document.querySelector('.catalogue-header h2');
  if (viewFilter === 'items') headerTitle.textContent = 'Individual Items';
  else if (viewFilter === 'sets') headerTitle.textContent = 'Furniture Sets';
  else headerTitle.textContent = 'All Products';

  document.querySelector('.results-count').textContent = `Showing ${visibleCount} results`;
  noResults.style.display = visibleCount === 0 ? 'block' : 'none';

  if (cataloguePagination) {
    cataloguePagination.refresh();
  }

  updateAdaptiveFilters();
}

function updateAdaptiveFilters() {
  const viewFilter = document.getElementById('view-filter').value;
  const roomFilter = currentRoomFilter;
  const typeFilter = document.getElementById('type-filter');
  const styleFilter = document.getElementById('style-filter');

  const selectedType = typeFilter.value;
  const selectedStyle = styleFilter.value;

  const currentCards = Array.from(document.querySelectorAll('.catalogue-item'));
  const availableTypes = new Set();
  const availableStyles = new Set();

  currentCards.forEach(card => {
    const matchesView = (viewFilter === 'all') ||
                        (viewFilter === 'sets' && card.dataset.productType === 'set') ||
                        (viewFilter === 'items' && card.dataset.productType === 'item');
    const matchesRoom = !roomFilter || card.dataset.room === roomFilter;

    if (matchesView && matchesRoom) {
      if (card.dataset.type) availableTypes.add(card.dataset.type);
      if (card.dataset.style) availableStyles.add(card.dataset.style);
    }
  });

  // Update Type Filter options (Native Select & Custom UI)
  const typeOptions = Array.from(availableTypes).sort();
  let typeSelectHtml = '<option value="">All Types</option>';
  let typeCustomHtml = `<div class="custom-option ${!selectedType ? 'active' : ''}" onclick="selectCustomOption('type', '', 'All Types')">All Types</div>`;

  typeOptions.forEach(t => {
    const selected = t === selectedType;
    typeSelectHtml += `<option value="${t}" ${selected ? 'selected' : ''}>${t}</option>`;
    typeCustomHtml += `<div class="custom-option ${selected ? 'active' : ''}" onclick="selectCustomOption('type', '${t}', '${t}')">${t}</div>`;
  });
  typeFilter.innerHTML = typeSelectHtml;
  document.getElementById('type-options').innerHTML = typeCustomHtml;

  // Update Style Filter options (Native Select & Custom UI)
  const styleOptions = Array.from(availableStyles).sort();
  let styleSelectHtml = '<option value="">All Styles</option>';
  let styleCustomHtml = `<div class="custom-option ${!selectedStyle ? 'active' : ''}" onclick="selectCustomOption('style', '', 'All Styles')">All Styles</div>`;

  styleOptions.forEach(s => {
    const selected = s === selectedStyle;
    styleSelectHtml += `<option value="${s}" ${selected ? 'selected' : ''}>${s}</option>`;
    styleCustomHtml += `<div class="custom-option ${selected ? 'active' : ''}" onclick="selectCustomOption('style', '${s}', '${s}')">${s}</div>`;
  });
  styleFilter.innerHTML = styleSelectHtml;
  document.getElementById('style-options').innerHTML = styleCustomHtml;
}

function clearFilters() {
  currentRoomFilter = '';
  const tabs = document.querySelectorAll('#room-tabs .style-tab');
  tabs.forEach(tab => {
    if (tab.getAttribute('data-room') === '') tab.classList.add('active');
    else tab.classList.remove('active');
  });

  // Reset View
  document.getElementById('view-filter').value = 'all';
  document.getElementById('view-trigger-text').textContent = 'All';
  document.querySelectorAll('#view-options .custom-option').forEach(opt => {
    if (opt.textContent.trim() === 'All View') opt.classList.add('active');
    else opt.classList.remove('active');
  });

  // Reset Type
  document.getElementById('type-filter').value = '';
  document.getElementById('type-trigger-text').textContent = 'All Types';

  // Reset Style
  document.getElementById('style-filter').value = '';
  document.getElementById('style-trigger-text').textContent = 'All Styles';

  applyFilters();
}

document.addEventListener('DOMContentLoaded', function() {
  cataloguePagination = initPagination({
    gridSelector: '.catalogue-products',
    itemSelector: '.catalogue-item',
    paginationSelector: '#catalogue-pagination',
    desktopPerPage: 18,
    mobilePerPage: 6
  });

  applyFilters();
});
</script>