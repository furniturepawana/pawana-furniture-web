<!-- Catalogue Page -->
<section class="catalogue-hero">
  <div class="catalogue-hero-content">
    <h1>Our Collection</h1>
    <p>Explore our exquisite range of handcrafted furniture</p>
  </div>
</section>

<section class="catalogue-section">
  <div class="catalogue-container">
    <!-- Breadcrumb -->
    <section class="breadcrumb-section">
      <div class="breadcrumb-container">
        <div class="page-breadcrumb">
          <a href="javascript:history.back()" class="breadcrumb-back" aria-label="Go back">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12h18M3 12l6-6M3 12l6 6"/>
            </svg>
          </a>
          <a href="/">Home</a> /
          <span>Catalogue</span>
        </div>
      </div>
    </section>

    <!-- Products Area with Top Filters -->
    <div class="catalogue-products">

      <!-- Header with Dropdown Filters -->
      <div class="catalogue-header">
        <div class="catalogue-header-left">
          <div class="title-block">
            <h2>
              <% if (filters.view === 'items') { %>
                Individual Items
              <% } else if (filters.view === 'sets') { %>
                Furniture Sets
              <% } else { %>
                All Products
              <% } %>
            </h2>
            <p class="results-count">
              Showing <%= (filters.view === 'all' || filters.view === 'items' ? items.length : 0) + (filters.view === 'all' || filters.view === 'sets' ? sets.length : 0) %> results
            </p>
          </div>
        </div>

        <!-- Room Tabs (Center) -->
        <div class="room-filter-tabs style-filter-tabs filter-tabs-compact" id="room-tabs">
          <%
            const roomDisplayNames = {
              'Living Room': 'Living',
              'Bedroom': 'Bedroom',
              'Dining Room': 'Dining',
              'Office': 'Office',
              'Showpieces': 'Showpieces'
            };
            const roomOrder = ['Living Room', 'Bedroom', 'Dining Room', 'Office', 'Showpieces'];
            const sortedRooms = [...allRooms].sort((a, b) => roomOrder.indexOf(a) - roomOrder.indexOf(b));
          %>
          <button class="style-tab active" data-room="" onclick="updateRoomFilter('')">All</button>
          <% sortedRooms.forEach(room => { %>
            <button class="style-tab" data-room="<%= room %>" onclick="updateRoomFilter('<%= room %>')">
              <%= roomDisplayNames[room] || room %>
            </button>
          <% }); %>
        </div>

        <!-- Dropdown Filters (Right) -->
        <div class="catalogue-filters-right">
          <!-- View Dropdown -->
          <div class="filter-dropdown">
            <select id="view-filter" onchange="updateFilter('view', this.value)">
              <option value="all" <%= filters.view === 'all' ? 'selected' : '' %>>All</option>
              <option value="items" <%= filters.view === 'items' ? 'selected' : '' %>>Items</option>
              <option value="sets" <%= filters.view === 'sets' ? 'selected' : '' %>>Sets</option>
            </select>
          </div>

          <!-- Type Dropdown -->
          <div class="filter-dropdown">
            <select id="type-filter" onchange="updateFilter('type', this.value)">
              <option value="" <%= !filters.type ? 'selected' : '' %>>All Types</option>
              <% allTypes.forEach(type => { %>
                <option value="<%= type %>" <%= filters.type && filters.type.toLowerCase() === type.toLowerCase() ? 'selected' : '' %>><%= type %></option>
              <% }); %>
            </select>
          </div>

          <!-- Style Dropdown -->
          <div class="filter-dropdown">
            <select id="style-filter" onchange="updateFilter('style', this.value)">
              <option value="" <%= !filters.style ? 'selected' : '' %>>All Styles</option>
              <% allStyles.forEach(style => { %>
                <option value="<%= style %>" <%= filters.style === style ? 'selected' : '' %>><%= style %></option>
              <% }); %>
            </select>
          </div>

          <!-- Clear Filters Button -->
          <button class="clear-filters-btn-top" onclick="clearFilters()" title="Clear all filters">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Sets Grid (First row) -->
      <div class="catalogue-sets-grid">
        <% sets.forEach(set => { %>
          <div class="set-card-wrapper catalogue-item"
             data-style="<%= set.style %>"
             data-room="<%= set.room %>"
             data-product-type="set">
            <a href="/set/<%= set.slug %>" class="set-card">
              <div class="set-card-badge">Set</div>
              <img
                src="<%= set.images && set.images.length > 0 ? set.images[0].url : '/images/placeholder.jpg' %>"
                alt="<%= set.name %>"
              />
              <div class="card-name-row">
                <h3><%= set.name %></h3>
                <button class="wishlist-btn"
                        data-id="<%= set._id %>"
                        data-type="set"
                        data-name="<%= set.name %>"
                        data-slug="<%= set.slug %>"
                        data-image="<%= set.images && set.images.length > 0 ? set.images[0].url : '/images/placeholder.jpg' %>"
                        onclick="handleWishlistClick(event, this)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                  </svg>
                </button>
              </div>
              <div class="set-card-meta">
                <span class="set-style-badge <%= set.style.toLowerCase() %>"><%= set.style %></span>
                <p><%= set.room %> · <%= set.code %></p>
              </div>
            </a>
          </div>
        <% }); %>
      </div>

      <!-- Items Grid -->
      <div class="catalogue-items-grid">
        <% items.forEach(item => { %>
          <div class="product-card-wrapper catalogue-item"
             data-style="<%= item.style %>"
             data-room="<%= item.room %>"
             data-type="<%= item.type %>"
             data-product-type="item">
            <a href="/item/<%= item.slug %>" class="product-card">
              <img
                src="<%= item.images && item.images.length > 0 ? item.images[0].url : '/images/placeholder.jpg' %>"
                alt="<%= item.name %>"
              />
              <div class="card-name-row">
                <h3><%= item.name %></h3>
                <button class="wishlist-btn"
                        data-id="<%= item._id %>"
                        data-type="item"
                        data-name="<%= item.name %>"
                        data-slug="<%= item.slug %>"
                        data-image="<%= item.images && item.images.length > 0 ? item.images[0].url : '/images/placeholder.jpg' %>"
                        onclick="handleWishlistClick(event, this)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                  </svg>
                </button>
              </div>
              <div class="product-card-meta">
                <span class="item-style-badge <%= item.style.toLowerCase() %>"><%= item.style %></span>
                <p><%= item.room %> · <%= item.type %> · <%= item.code %></p>
              </div>
            </a>
          </div>
        <% }); %>
      </div>

      <!-- Pagination (at bottom) -->
      <div class="pagination-container" id="catalogue-pagination"></div>

      <!-- No Results -->
      <div class="no-results" style="display: none;">
        <h3>No products found</h3>
        <p>Try adjusting your filters to see more results</p>
        <button class="btn-primary" onclick="clearFilters()">Clear Filters</button>
      </div>
    </div>

  </div>
</section>

<script>
let cataloguePagination = null;
let currentRoomFilter = '';
let allFilterData = {
  types: [],
  styles: []
};

// Capture all unique types and styles on load
document.addEventListener('DOMContentLoaded', function() {
  const cards = document.querySelectorAll('.catalogue-item');
  const typeSet = new Set();
  const styleSet = new Set();

  cards.forEach(card => {
    if (card.dataset.type) typeSet.add(card.dataset.type);
    if (card.dataset.style) styleSet.add(card.dataset.style);
  });

  allFilterData.types = Array.from(typeSet).sort();
  allFilterData.styles = Array.from(styleSet).sort();
});

function updateRoomFilter(value) {
  currentRoomFilter = value;

  // Update active tab UI
  const tabs = document.querySelectorAll('#room-tabs .style-tab');
  tabs.forEach(tab => {
    if (tab.getAttribute('data-room') === value) {
      tab.classList.add('active');
    } else {
      tab.classList.remove('active');
    }
  });

  applyFilters();
}

function updateFilter(filterName, value) {
  // If type filter is changed to a specific type (not "All Types"), automatically select "Items"
  if (filterName === 'type' && value !== '') {
    document.getElementById('view-filter').value = 'items';
  }
  applyFilters();
}

function applyFilters() {
  const viewFilter = document.getElementById('view-filter').value;
  const roomFilter = currentRoomFilter;
  const typeFilter = document.getElementById('type-filter').value;
  const styleFilter = document.getElementById('style-filter').value;

  const allCards = document.querySelectorAll('.catalogue-item');
  const setsGrid = document.querySelector('.catalogue-sets-grid');
  const itemsGrid = document.querySelector('.catalogue-items-grid');
  const noResults = document.querySelector('.no-results');

  let visibleCount = 0;
  let visibleSets = 0;
  let visibleItems = 0;

  // Filter all catalogue items using ONLY data-filtered-out attribute
  // Pagination will handle the actual display visibility
  allCards.forEach(card => {
    const productType = card.dataset.productType; // 'set' or 'item'
    const style = card.dataset.style;
    const room = card.dataset.room;
    const type = card.dataset.type; // furniture type (for items only)

    let show = true;

    // View filter
    if (viewFilter === 'sets' && productType !== 'set') show = false;
    if (viewFilter === 'items' && productType !== 'item') show = false;

    // Style filter
    if (styleFilter && style !== styleFilter) show = false;

    // Room filter
    if (roomFilter && room !== roomFilter) show = false;

    // Type filter (only applies to items)
    if (typeFilter) {
      if (productType === 'set') {
        show = false; // Hide sets when type filter is active
      } else if (type && type.toLowerCase() !== typeFilter.toLowerCase()) {
        show = false;
      }
    }

    // Only use data attribute - let pagination handle visibility
    if (show) {
      card.removeAttribute('data-filtered-out');
      visibleCount++;
      if (productType === 'set') visibleSets++;
      else visibleItems++;
    } else {
      card.setAttribute('data-filtered-out', 'true');
      card.style.display = 'none'; // Hide filtered items immediately
    }
  });

  // Hide grids that have no visible items (prevents empty space)
  setsGrid.style.display = visibleSets > 0 ? 'grid' : 'none';
  itemsGrid.style.display = visibleItems > 0 ? 'grid' : 'none';

  // Update header title
  const headerTitle = document.querySelector('.catalogue-header h2');
  if (viewFilter === 'items') {
    headerTitle.textContent = 'Individual Items';
  } else if (viewFilter === 'sets') {
    headerTitle.textContent = 'Furniture Sets';
  } else {
    headerTitle.textContent = 'All Products';
  }

  // Update results count
  document.querySelector('.results-count').textContent = `Showing ${visibleCount} results`;

  // Show/hide no results message
  noResults.style.display = visibleCount === 0 ? 'block' : 'none';

  // Refresh pagination after filter - this will show correct items for page 1
  if (cataloguePagination) {
    cataloguePagination.refresh();
  }

  updateAdaptiveFilters();
}

function updateAdaptiveFilters() {
  const viewFilter = document.getElementById('view-filter').value;
  const roomFilter = currentRoomFilter;
  const typeFilter = document.getElementById('type-filter');
  const styleFilter = document.getElementById('style-filter');

  const selectedType = typeFilter.value;
  const selectedStyle = styleFilter.value;

  const currentCards = Array.from(document.querySelectorAll('.catalogue-item'));

  // Calculate available types based on current View and Room (and Style if we want full adaptive)
  // For standard "cascading" behavior, we filter options based on other selections.

  const availableTypes = new Set();
  const availableStyles = new Set();

  currentCards.forEach(card => {
    // Check if this card matches VIEW and ROOM (the primary filters)
    const matchesView = (viewFilter === 'all') ||
                        (viewFilter === 'sets' && card.dataset.productType === 'set') ||
                        (viewFilter === 'items' && card.dataset.productType === 'item');
    const matchesRoom = !roomFilter || card.dataset.room === roomFilter;

    if (matchesView && matchesRoom) {
      if (card.dataset.type) availableTypes.add(card.dataset.type);
      if (card.dataset.style) availableStyles.add(card.dataset.style);
    }
  });

  // Update Type Filter options
  const typeOptions = Array.from(availableTypes).sort();
  let typeHtml = '<option value="">All Types</option>';
  typeOptions.forEach(t => {
    const selected = t === selectedType ? 'selected' : '';
    typeHtml += `<option value="${t}" ${selected}>${t}</option>`;
  });
  typeFilter.innerHTML = typeHtml;

  // Update Style Filter options
  const styleOptions = Array.from(availableStyles).sort();
  let styleHtml = '<option value="">All Styles</option>';
  styleOptions.forEach(s => {
    const selected = s === selectedStyle ? 'selected' : '';
    styleHtml += `<option value="${s}" ${selected}>${s}</option>`;
  });
  styleFilter.innerHTML = styleHtml;
}

function clearFilters() {
  currentRoomFilter = '';
  // Update tabs
  const tabs = document.querySelectorAll('#room-tabs .style-tab');
  tabs.forEach(tab => {
    if (tab.getAttribute('data-room') === '') tab.classList.add('active');
    else tab.classList.remove('active');
  });

  document.getElementById('type-filter').value = '';
  document.getElementById('style-filter').value = '';
  document.getElementById('view-filter').value = 'all';
  applyFilters();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Initialize pagination first
  cataloguePagination = initPagination({
    gridSelector: '.catalogue-products',
    itemSelector: '.catalogue-item',
    paginationSelector: '#catalogue-pagination',
    desktopPerPage: 15,
    mobilePerPage: 6
  });

  // Then apply filters (which will call refresh)
  applyFilters();
});
</script>